<!DOCTYPE html>
<html>

<head>
</head>

<body>
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-firestore.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBEUoYf-ublKZK_hgalXYkHDfwyS5_reSI",
        authDomain: "fir-realtime-test-7bf25.firebaseapp.com",
        databaseURL: "https://fir-realtime-test-7bf25.firebaseio.com",
        projectId: "fir-realtime-test-7bf25",
        storageBucket: "fir-realtime-test-7bf25.appspot.com",
        messagingSenderId: "130594666380"
      };
      firebase.initializeApp(config);

      let userID
      const app = firebase.app();
      const auth = app.auth()
      const db = app.firestore()

      let playerRef
      const otherPlayerUnSubs = new Map()

      auth.onAuthStateChanged(user => {
        if (user) {
          userID = user.uid
          console.log("signed in as " + userID)
          playerRef = db.collection("Players").doc(userID)
          playerRef.set({
            online: true
          })

          subToOtherPlayers()
        } else {
          firebase.auth().signInAnonymously()
        }
      })

      window.addEventListener("mousemove", event => {
        playerRef.update({
          x: event.pageX,
          y: event.pageY
        })
      })

      function subToOtherPlayers() {
        db.collection("Players").where("online", "==", true)
          .onSnapshot(querySnapshot => {
            querySnapshot.docChanges().forEach(change => {
              if (change.type === "added") {
                if(change.doc.id != userID){
                  otherPlayerUnSubs.set(change.doc.id, change.doc.ref.onSnapshot(subToPlayer))
                }
              }
              if (change.type === "removed") {
                otherPlayerUnSubs.get(hange.doc.id)()
              }
            })
          })
      }

      function subToPlayer(playerSnapshot) {
        const {id, x, y} = playerSnapshot.data()
        console.log(`id: ${id} x: ${x} y: ${y}`)
      }
    })
  </script>
</body>

</html>